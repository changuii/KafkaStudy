# 6.2 그룹 코디네이터


컨슈머들은 하나의 컨슈머 그룹의 구성원으로 속하며, 컨슈머 그룹 내의 각 컨슈머들은 서로 자신의 정보를 공유하면서 하나의 공동체로 동작합니다.  
컨슈머 그룹 내의 컨슈머들은 언제든지 자신이 속한 컨슈머 그룹에서 떠날 수 있으며 새로운 컨슈머가 합류할 수도 있습니다.  

따라서 컨슈머 그룹은 이러한 변화를 인지하고 각 컨슈머들에게 작업을 균등하게 분배해야 합니다.  
컨슈머 그룹에서 각 컨슈머들에게 작업을 균등하게 분배하는 동작을 `컨슈머 리밸런싱(consumer rebalancing)`이라고 부르거나 `컨슈머 리밸런싱이 일어났다`라고 표현합니다.  

컨슈머 그룹 역시 안정적인 컨슈머 그룹 관리를 위해 별도의 코디네이터가 존재하는데, 이를 카프카에서는 `그룹 코디네이터(group coordinator)`라고 부릅니다.  
그룹 코디네이터의 목적은 컨슈머 그룹이 구독한 토픽의 파티션들과 그룹의 멤버들을 트래킹(tracking)하는 것입니다.  

따라서 파티션 또는 그룹의 멤버에 변화가 생기면, 작업을 균등하게 재분배하기 위해 컨슈머 리밸런싱 동작이 발생합니다.  
그룹 코디네이터는 카프카 클러스터 내의 브로커 중 하나에 위치합니다.  

컨슈머 그룹이 브로커에 최초 연결 요청을 보내면 브로커 중 하나에 그룹 코디네이터가 생성되고, 이 그룹 코디네이터는 컨슈머 그룹의 컨슈머 변경과 구독하는 토픽 파티션 변경 등에 대한 감지를 시작합니다.  
그리고 토픽의 파티션 그룹의 멤버 변경이 일어나면 변경된 내용을 컨슈머들에게 알려주기도 합니다.  

## 6.2.1 컨슈머 그룹과 그룹 코디네이터의 동작 과정


동작과정  
1. 컨슈머는 컨슈머 설정값 중에서 bootstrap.brokers 리스트에 있는 브로커에게 컨슈머 클라이언트와 초기 커넥션을 연결하기 위한 요청을 보냅니다.  
2. 해당 요청을 받은 브로커는 그룹 코디네이터를 생성하고 컨슈머에게 응답을 보냅니다. 컨슈머 그룹의 첫 번째 컨슈머가 등록될 때까지 아무 작업도 일어나지 않습니다.
3. 그룹 코디네이터는 group.initial.reblance.delay.ms의 시간 동안 컨슈머의 요청을 기다립니다. 
4. 컨슈머는 컨슈머 등록 요청을 그룹 코디네이터에게 보냅니다. 이때 가장 먼저 요청을 보내는 컨슈머가 컨슈머 그룹의 리더가 됩니다.
5. 컨슈머 등록 요청을 받은 그룹 코디네이터는 해당 컨슈머 그룹이 구독하는 토픽 파티션 리스트 등 리더 컨슈머의 요청에 응답을 보냅니다.
6. 리더 컨슈머는 정해진 컨슈머 파티션 할당 전략에 따라 그룹 내 컨슈머들에게 파티션을 할당한 뒤 그룹 코디네이터에게 전달합니다.
7. 그룹 코디네이터는 해당 정보를 캐시하고 각 그룹 내 컨슈머들에게 성공을 알립니다.
8. 각 컨슈머들은 각자 지정된 토픽 파티션으로부터 메시지들을 가져옵니다.  



## 6.2.2 그룹 코디네이터의 관리

이제 컨슈머 그룹은 그룹 코디네이터와 연결되어 관리를 받게 됩니다.  
컨슈머들은 현재 자신들이 속한 컨슈머 그룹에서 빠져나갈 수도, 새롭게 합류할 수도 있습니다.  

이러한 컨슈머 그룹의 변화들은 컨슈머 코디네이터에게 컨슈머가 join 또는 leave 요청을 보냅으로써 자연스럽게 처리됩니다.  
하지만 컨슈머가 장애로 leave 요청을 보내지 못하고 종료되는 경우 그룹 코디네이터는 어떻게 이를 감지할 수 있을까요?  

컨슈머들의 변경을 감지하기 위해 그룹 코디네이터와 컨슈머들은 서로 하트비트(heartbeat)를 주고받습니다.  
이렇게 하트비트를 주기적으로 주고받으면서 그룹 코디네이터는 컨슈머가 살아있는지, 잘 동작하는지를 확인합니다.  

그룹 코디네이터는 방금 살펴본 하트비트 옵션을 통해 컨슈머의 상태를 확인하며, 특정 컨슈머에 문제가 발생했다고 판단되면 컨슈머 리밸런싱 동작을 통해 컨슈머 그룹의 전체 균형을 다시 맞춥니다.  
하트비트만으로도 컨슈머의 상태를 체크할 수 있지만, 할당된 파티션에서 컨슈머가 정상적으로 메시지를 가져가고 있는지를 poll() 동작 여부를 통해 확인하는 등 카프카의 세심하고 상세한 설정을 엿볼 수 있습니다.  

컨슈머 리밸런싱 동작은 경우에 따라 매우 높은 비용이 지출되므로 가급적 리밸런싱이 자주 발생하지 않도록 주의해야 합니다.  

그룹 코디네이터가 컨슈머의 다운을 빠르게 감지하도록 설정해둔다면, 일시적인 컨슈머의 타임아웃이나 일시적인 TCP 패킷 손실로 인해 원하지 않은 리밸런싱이 빈번하게 일어나는 현상이 발생할 수도 있습니다.  
반대로 그룹 코디네이터가 컨슈머 다운을 늦게 감지하도록 설정해두면, 그 시간만큼 해당 파티션의 메시지를 읽지 못하는 현상이 발생할 수도 있습니다.  







