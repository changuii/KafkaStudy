# 6.4 컨슈머 파티션 할당 전략  

컨슈머 그룹의 리더 컨슈머가 정해진 파티션 할당 전략에 따라 각 컨슈머와 대상 토픽의 파티션을 매칭시킵니다.  
파티션 할당 전략은 컨슈머 옵션의 partition.assignment.strategy로 표시합니다.  

카프카에서 제공하는 4가지 할당전략  
- `RangeAssignor(레인지 전략)`
- `RoundRobinAssignor(라운드 로빈 전략)`
- `StickyAssignor(스티키 전략)`
- `CooperativeStickyAssignor(협력적 스티키 전략)`

| 파티션 할당 전략              | 설졍                                                                                                               |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 레인지 파티션 할당전략        | 파티션 할당 전략의 기본값으로서 토픽별로 할당 전략을 사용함. 동일한 키를 이용하는 2개 이상의 토픽을 컨슘할 때 유용 |
| 라운드 로빈 파티션 할당전략   | 사용가는한 파티션과 컨슈머들을 라운드 로빈으로 할당함. 균등한 분배 가능                                            |
| 스티키 파티션 할당전략        | 컨슈머가 컨슘하고 있는 파티션을 계속 유지할 수 있음                                                                |
| 협력적 스티키 파티션 할당전략 | 스티키 방식과 유사하지만, 전체 일시 정지가 아닌 연속적인 재조정 방식임 |  


## 6.4.1 레인지 파티션 할당 전략  

레인지 파티션 할당 전략인 RangeAssignor는 파티션 할당 전략 중 기본값으로서, 각 토픽별로 할당 전략을 사용하게 됩니다.  
레인지 파티션 할당 전략은 먼저 구독하는 토픽에 대한 파티션을 순서대로 나열한 후 컨슈머 수로 나눕니다.  

컨슈머 수와 파티션 수가 일치하면 균등하게 할당될 수 있지만 균등하게 나눠지지 않는 경우에는 앞쪽의 컨슈머들은 추가 파티션을 할당받게 됩니다.  
컨슈머 그룹이 구독하고자 하는 토픽1과 토픽2라는 2개의 토픽이 있고 파티션 수는 각각 3개로 구성되어 있습니다.  

먼저 파티션 0,1,2를 순서대로 정렬합니다.  
그리고 컨슈머를 컨슈머1, 컨슈머2 순서대로 정렬한 뒤 전체 파티션 수(3)를 전체 컨슈머 수(2)로 나눕니다.  

3에서 2를 나눈 결과로 컨슈머당 최소 하나의 파티션을 가져야 합니다.  
하지만 균등하게 나눠지지 않으므로, 먼저 정렬된 컨슈머인 컨슈머1에 남은 파티션을 추가 할당합니다.  

그리고 두 번째 토픽도 이와 동일한 방법으로 파티션을 할당합니다.  
결국 컨슈머 1은 총 4개의 파티션을 담당하고, 컨슈머2는 총 2개의 파티션만 담당하게 됩니다.  

불균형하게 할당되는 레인지 파티션 할당 전략은 왜 이용할까요?  
레인지 파티션 할당 전략은 동일한 레코드(메시지) 키를 사용하고 하나의 컨슈머 그룹이 동일한 파티션 수를 가진 2개 이상의 토픽을 컨슘할 때 유용할 수 있습니다.  

예를 들어 토픽1의 0번 파티션은 프로듀서가 보내는 레코드의 키값 abc에 의해 기록된다고 가정하고, 토픽2의 0번 파티션 역시 프로듀서가 보내는 레코드의 키값 abc에 의해 기록된다고 가정해보겠습니다.  
레인지 파티션 할당 전략을 적용하면, 컨슈머1에는 토픽1의 0번 파티션과 토픽2의 0번 파티션이 동시에 할당되어 두 토픽의 0번 파티션을 컨슈머1이 모두 컨슘하게 됩니다.  

결과적으로, 동일한 키값 abc를 갖고 있는 두 토픽의 파티션을 하나의 컨슈머가 컨슘하는 것입니다.  

레인지 파티션 할당 전략은 방금 설명한 사례와 같이 특수한 환경에서 사용하는 것이 좋지만, 컨슈머에 균등하게 파티션이 분배되지 않으므로 컨슈머 그룹은 불균형한 상태로 운영될 수 있다는 점에 유의해야 합니다.  


## 6.4.2 라운드 로빈 파티션 할당 전략

라운드 로빈 파티션 할당 전략은 파티션 할당 전략 중 가장 간단한 할당 방식입니다.  
먼저 컨슘해야 하는 모든 파티션과 컨슈머 그룹 내 모든 컨슈머를 나열한 후 라운드 로빈으로 하나씩 파티션과 컨슈머를 할당하는 전략입니다.  

| 파티션        | 매핑된 컨슈머 |
| ------------- | ------------- |
| 토픽1-파티션0 | 컨슈머1       |
| 토픽1-파티션1 | 컨슈머2       |
| 토픽1-파티션2 | 컨슈머1       |
| 토픽2-파티션0 | 컨슈머2       |
| 토픽2-파티션1 | 컨슈머1       |
| 토픽2-파티션2 | 컨슈머2       |  

따라서 레인지 파티션 할당 전략에 비해 라운드 로빈 파티션 할당 전략 쪽이 파티션과 컨슈머를 더욱 균등하게 매핑합니다.  


## 6.4.3 스티키 파티션 할당 전략  

만약 컨슈머 그룹의 리밸런싱 동작으로 인해 파티션이 재할당된다면 어떤 상황이 벌어질까요?  
레인지 파티션 할당 전략과 라운드 로빈 파티션 할당 전략 모두 파티션 재할당 작업이 발생하면, 기존에 매핑됐던 파티션과 동일한 컨슈머가 다시 매핑되리라고는 보장할 수 없습니다.  

즉, 토픽1의 파티션0이 컨슈머1에 할당되어 있지만, 재할당 작업이 발생하는 경우 토픽1의 파티션0은 컨슈머 2에게 할당될 수 있습니다.  
따라서 이러한 재할당 작업이 발생하더라도 기존에 매핑됐던 파티션과 컨슈머를 최대한 유지하려고 하는 전략이 바로 스티키 파티션 할당 전략입니다.  

스티키 파티션 할당 전략은 두 가지 목적으로 컨슈머에게 파티션을 할당합니다.  
첫 번째 목적은 가능한 한 균형 잡힌 파티션 할당이고, 두 번째 목적은 재할당이 발생할 때 되도록 기존의 할당된 파티션 정보를 보장하는 것입니다.  

둘 중에서는 가능한 한 균형잡힌 파티션 할당이 우선순위가 높습니다.  
따라서 스티키 할당 전략이라고 해서 무조건 기존의 파티션과 컨슈머를 유지하지는 않습니다.  

컨슈머2에 문제가 발생해 컨슈머2가 컨슈머 그룹에서 떠나게 됩니다.  
그러면 컨슈머 그룹에서는 리밸런싱이 발생합니다.  

이렇게 컨슈머2가 컨슈머 그룹에서 떠났을 때 라운드 로빈 전략과 비교해보겠습니다.  

라운드 로빈 전략  
1. 컨슈머2가 컨슈머 그룹에서 떠남
2. 리밸런싱 동작이 발생
3. 모든 파티션을 순서대로 배치
4. 모든 컨슈머를 순서대로 배치
5. 라운드 로빈 파티션 할당 전략에 맞춰 하나씩 매핑

| 파티션        | 매핑된 컨슈머 |
| ------------- | ------------- |
| 토픽1-파티션0 | 컨슈머1       |
| 토픽1-파티션1 | 컨슈머3       |
| 토픽2-파티션0 | 컨슈머1       |
| 토픽2-파티션1 | 컨슈머3       |
| 토픽3-파티션0 | 컨슈머1       |
| 토픽3-파티션1 | 컨슈머3       |
| 토픽4-파티션0 | 컨슈머1       |
| 토픽4-파티션1 | 컨슈머3       |  

컨슈머 그룹의 리밸런싱으로 인해 새로운 파티션이 할당됩니다.  

스티키 파티션 할당 전략  

기존 컨슈머1과 컨슈머3에 할당됐던 파티션들은 모두 유지한 채, 컨슈머2에 할당된 파티션들만 컨슈머1과 컨슈머3에 각각 할당됩니다.  
라운드 로빈과 비교해보면 컨슈머1과 컨슈머3에 이미 할당된 파티션들은 유지되고, 컨슈머가 할당되지 않은 파티션들에 대해서만 컨슈머1과 컨슈머3에 할당됐습니다.  

스티키 파티션 할당 전략의 규칙  
- 컨슈머들의 최대 할당된 파티션 수의 차이는 1
- 기존에 존재하는 파티션 할당은 최대한 유지함
- 재할당 동작 시 유효하지 않은 모든 파티션 할당은 제거함
- 할당되지 않은 파티션들은 균형을 맞추는 방법으로 컨슈머들에게 할당  

스티키 파티션 할당 전략은 최대한 컨슈머들의 균형을 맞추고 기존 컨슈머에 할당된 파티션을 최대한 유지함으로써 컨슈머에 새로 할당하는 파티션 수를 최소화합니다.  
이렇게 최소한의 움직임으로 컨슈머를 할당할 수 있으므로 라운드 로빈 할당 전략보다 효율적입니다.  

## 6.4.4 협력적 스티키 파티션 할당 전략  

협력적 스티키 파티션 전략은 결과적으로 본다면 스티키 전략과 동일한 방식입니다.  
즉 리밸런싱이 일어나도 기존의 컨슈머와 파티션 매핑은 유지하고 최소한의 파티션만 컨슈머와 매핑합니다.  

하지만 협력적 스티키 파티션 할당 전략은 컨슈머 그룹 내부의 리밸런싱 동작이 한층 더 고도화되었습니다.  

지금까지의 컨슈머 리밸런싱 동작은 내부적으로 EAGER라는 리밸런스 프로토콜을 사용했고, EAGER 프로토콜은 컨슈머 리밸런싱 동작 시 컨슈머에 할당된 모든 파티션을 항상 취소했습니다.  
취소하는 이유로는   
1. 컨슈머들의 파티션 소유권 변경 : 0번 파티션의 소유권을 B컨슈머에게 할당해야할 때 하나의 컨슈머 내에서는 둘 이상의 컨슈머가 동일한 파티션을 소유할 수 없으므로, B 컨슈머에게 소유권을 넘길 수 없습니다. 따라서 파티션0은 어떤 컨슈머도 소유권을 가지면 안됩니다.
2. 그룹 내에서 여러 파티션들에 대해 소유권 변경 작업이 동시에 이뤄져야 합니다 : 이러한 로직을 단순하게 구현하기 위해  

리밸런싱에서 모든 파티션 할당을 취소하는 동작은 리소스를 많이 사용하는 컨슈머 그룹에서는 큰 문제가 됩니다.  
바로 컨슈머들의 다운타임입니다.  

EAGER, (감지, 중지, 재시작) 동작 과정

첫 번째 감지 단계에서 peter-kafka02의 컨슈머가 다운됨을 감지했습니다.  
두 번째 중지 단계에서 컨슈머에게 할당된 모든 파티션을 제거합니다.
- 이 단계부터 컨슈머에게 할당된 파티션이 없으므로, 컨슈머의 다운타임이 시작됩니다.  
- 컨슈머와 프로듀서의 동작은 분리되어 있으므로 컨슈머가 리밸런싱 하는 도중에도 프로듀서는 해당 토픽으로 계속 메시지를 전송하고 있습니다. 즉, 컨슈머의 다운타임 동안 LAG(latency)이 급격히 증가합니다.  
마지막으로 세 번째 재시작 단꼐에서 구독합 파티션이 컨슈머들에게 재할당 됩니다.  
- 이 순간부터 컨슈머들은 각자 할당받은 파티션에서 메시지들을 컨슘하기 시작하고, 비로소 컨슈머의 다운타임이 종료됩니다.  

스태틱 멤버십 기능을 통해 불필요한 리밸런싱 동작을 막을 수 있지만, 불가피하게 리밸런싱이 일어나면 여전히 다운타임이 발생합니다.  
대량의 메시지를 컨슘하는 경우 매우 큰 부담이 됩니다.  

협력적 스티키는 내부 리밸런싱 프로토콜인 EAGER가 아닌 COOPERATIVE 프로토콜을 적용하여 리밸싱이 동작하기 전의 컨슈머 상태를 유지할 수 있게 했습니다.  

기존의 리밸런싱 동작은 한 번에 모든 파티션 할당 작업이 끝난다는 장점이 있지만, 전체 컨슈머가 일시적으로 멈춘 상태에서 리밸런싱이 이뤄진다는 제약이 있었습니다.  
하지만 협력적 스티키 할당 전략에서는 되도록 동작 중인 컨슈머들에게 영향을 주지 않는 상태에서 몇 차례에 걸쳐 리밸런싱이 이뤄집니다.  

COOPERATIVE, (감지, 중지, 재시작, 협력적 스티키 할당 전략) 동작 과정

1. 컨슈머 그룹에 peter-kafka01이 합류하면서 리밸런싱이 트리거 됩니다. (감지 단계)
2. 컨슈머 그룹 내 컨슈머들은 그룹 합류 요청과 자신들이 컨슘하는 토픽의 파티션 정보(소유권)를 그룹 코디네이터로 전송합니다. (감지 단계)
3. 그룹 코디네이터는 해당 정볼를 조합해 컨슈머 그룹의 리더에게 전송합니다. (감지 단계)
4. 컨슈머 그룹의 리더는 현재 컨슈머들이 소유한 파티션 정보를 활용해 제외해야 할 파티션 정보를 담은 새로운 파티션 할당 정보를 컨슈머 그룹 멤버들에게 전달합니다. (첫 번째 리밸런싱 단계)
5. 새로운 파티션 할당 정보를 받은 컨슈머 그룹 멤버들은 현재의 파티션 할당 전략과 차이를 비교해보고 필요 없는 골라 제외합니다. 이전의 파티션 할당 정보와 새로운 파티션 할당 정보가 동일한 파티션들에 대해서는 어떤 작업도 수행할 필요가 없습니다. (첫 번째 리밸런싱 단계)
6. 제외된 파티션 할당을 위해 컨슈머들은 다시 합류 요청을 합니다. 여기서 두 번째 리밸런싱이 트리거됩니다. (두 번째 리밸런싱 단계)
7. 컨슈머 그룹의 리더는 제외된 파티션을 적절한 컨슈머에게 할당합니다. (두 번째 리밸런싱 단계)

협력적 스티키 파티션 할당 전략에서 중요한 점은 파티션 재배치가 필요하지 않은 컨슈머들은 다운타임 없이 계속 동작하며, 한 번이 아니라 두 차례의 리밸런싱이 일어났다는 점입니다.  
1. 첫 번째 리밸런싱 동작에서는 peter-kafka02가 소유하고 있던 2번 파티션만 제외됐고, 
2. 두 번째 리밸런싱 동작에서는 제외된 2버 파티션이 새로운 peter-kafka01 컨슈머에게 새롭게 할당됐습니다.  

비록 협력적 스티키 파티션 할당 전략에서는 리밸런싱 동작이 한 번에 완료되지 않았지만 현재 동작하고 있는 컨슈머에게는 아무런 영향을 주지 않습니다.  






