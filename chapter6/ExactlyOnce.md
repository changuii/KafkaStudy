# 6.5 정확히 한 번 컨슈머 동작  

프로듀서의 `정확히 한 번 전송` 동작을 위해 브로커 측에는 전체 트랜잭션을 관리하면서 프로듀서의 동작을 보조하는 별도의 트랜잭션 코디네이터가 필요했습니다.  
트랜잭션 코디네이터는 프로듀서의 동작을 보조하는 별도의 트랜잭션 코디네이터가 필요했습니다.  

트랜잭션 코디네이터는 프로듀서의 정확히 한 번 전송이 성공하면 해당 레코드의 트랜잭션 성공을 표시하는 특수한 메시지를 추가합니다.  
따라서 컨슈머는 트랜잭션 코디네이터가 특수한 메시지를 표시한 레코드만 읽는다면, 정확히 한 번 읽을 수 있습니다.  

컨슈머에서의 `정확히 한 번 전송`이 어떻게 동작하는지, 즉 프로듀서가 정확히 한 번 보낸 레코드들을 컨슈머가 어떻게 읽을 수 있는지 살펴보겠습니다.  

## 6.5.1 트랜잭션 컨슈머  

일반 컨슈머 코드에서 ISOLATION_LEVEL_CONFIG라는 설정만 추가하면 트랜잭션 컨슈머로 동작합니다.  
트랜잭션 컨슈머는 트랜잭션 코디네이터와 통신하는 부분은 없으며 트랜잭션이 완료된 메시지만 읽을 수 있습니다.  

기본값은 read_uncommitted로서 모든 메시지를 읽을 수 있다는 뜻이며, read_committed로 옵션값을 변경하면 트랜잭션이 완료된 메시지만 읽을 수 있습니다.  
메시지 전송 후 실행 중인 컨슈머의 마지막 부분을 확인해보면 한 건의 메시지가 추가됐음을 알 수 있습니다.  

여기서 중요한 점이 한 가지 있습니다.  
분명 한 건의 메시지를 전송했는데 오프셋이 2로 표시되어 있습니다.  

만약 일반적인 전송이었다면 두 번째 메시지의 오프셋은 1이어야 합니다.  
하지만 peter-test05 토픽의 메시지는 트랜잭션 프로듀서를 이용해 보낸 메시지이므로 두 번째 메시지의 오프셋은 2입니다.  

이렇게 오프셋이 하나 더 추가된 이유는 트랜잭션의 종료를 표시하기 위해 메시지 전송 후 커밋 또는 중단에 대한 표시를 남기는 트랜잭션 메시지가 추가되기 때문입니다.  
컨슈머는 일반적인 토픽의 메시지들을 읽어서 사용자들에게 보여주는데, 트랜잭션 메시지의 경우에는 트랜잭션의 성공 여부를 확인하는 목적으로만 활용하고 사용자에게 보여주지 않습니다.  

## 6.5.2 트랜잭션 컨슈머의 오해

많은 사용자가 오해할 수 있는데, 트랜잭션 컨슈머라고 해서 정확히 한 번만 가져오는 것은 아닙니다.  
프로듀서의 경우 트랜잭션 코디네이터와 통신하면서 해당 트랜잭션이 정확하게 처리되는 것을 보장했지만, 컨슈머의 경우 트랜잭션 프로듀서가 보낸 메시지만 가져올 수 있는지에 대해서만 옵션으로 선택할 수 있습니다.  

컨슈머는 트랜잭션 코디네이터와 통신하는 부분이 없으므로 정확하게 메시지를 한 번 가져오는지는 보장할 수 없습니다.  
또한 컨슈머에 의해 컨슘된 메시지가 다른 싱크 저장소로 중복 저장될 수 있습니다.  

만약 컨슈머가 정확하게 한 번 메시지를 가져왔다고 가정하더라도, 컨슈머가 가져온 메시지를 다른 애플리케이션에 저장하는 과정에서 중복 처리되는 경우가 있습니다.  
하지만 카프카 클라이언트인 컨슈머는 다른 싱크 저장소로 메시지들이 중복 저장되는 결과를 알 수 없으므로 정확히 한 번 저장을 보장할 수 없습니다.  

컨슈머의 동작까지 정확히 한 번 처리가 가능해지려면 `컨슘-메시지 처리-프로듀싱` 동작이 모두 하나의 트랜잭션으로 처리돼야 합니다.  
컨슘-메시지 처리-프로듀싱의 트랜잭션에서는 sendOffsetsToTransaction 메소드를 이용하며 컨슈머 그룹의 오프셋 커밋을 트랜잭션에 포함시킵니다.  

만약 이 처리 과정에서 트랜잭션 실패가 발생하면, 해당 컨슈머 그룹의 커밋 오프셋이 증가하지 않게 함으로써 실패한 트랜잭션을 다시 시작할 수 있습니다.  
일부 컨슈머 애플리케이션에서 정확히 한 번을 지원하는 경우도 있으므로, 사용하려는 컨슈머 애플리케이션의 가이드 문서를 잘 읽어보고 내가 원하는 기능이 맞는지 또는 구현 가능한지 여부를 꼭 확인해보고 적용하기 바랍니다.  

대부분 사용자들이 프로듀서-카프카 구간과 카프카-컨슈머 구간 모두에서 정확히 한 번 메시지 전송이 가능하다고 생각할 수 있지만 사실은 그렇지 않습니다.  
하지만 카프카 커넥트 중에서도 HDFS 커넥터의 경우에는 정확히 한 번 HDFS에 저장되도록 지원하기도 하므로, 사용하고자 하는 컨슈머 애플리케이션이 양 종단 간 정확히 한 번 메시지 전송을 지원하는지를 확인해보기 바랍니다.  


